<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>WebSocket Client</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel='icon' type='image/x-icon' href='/favicon.ico'>
    <link rel='stylesheet' href='/css/style.css'>
    <script src='/js/websocket.js'></script>
</head>
<body>
    <h1>ASP.NET Core Minimal API</h1>

    <ul>
        <li><a class="menuitem" href="/all">Demo Übersicht der aufgezeichneten Datenpunkte</a></li>
        <li><a class="menuitem" href="/html/soll/test.html">Demo Sollwertfenster</a></li>
        <li><a class="menuitem" href="/chart">Demo Kurvendarstellung</a></li>
        <li><a class="menuitem" id="rawjsonlink" href="#">Demo Json Rohdaten abfragen</a></li>
        <li><a class="menuitem" href="/excel">Demo Datenexport via Excel</a></li>
    </ul>

    <script>
        const start = new Date();
        start.setHours(0, 0, 0);
        start.toISOString().replace(" ", "%3A")

        const end = new Date();
        end.toISOString().replace(" ", "%3A");

        document.getElementById('rawjsonlink').setAttribute('href', `/db?tagnames=A01_DB10_DBW2%2CA01_DB10_DBW4%2CA01_DB10_DBW6&start=${start}&end=${end}`)
        //href="/db?tagnames=A01_DB10_DBW2%2CA01_DB10_DBW4%2CA01_DB10_DBW6&start=2025-11-24T08%3A17%3A00.000Z&end=2025-11-25T08%3A17%3A00.000Z"
    </script>

    <!--
    <h1>API Authentifizierung</h1>
    <label for="username">Benutzername:</label>
    <input type="text" id="username" value="admin"><br>
    <label for="password">Passwort:</label>
    <input type="password" id="password" value="geheim123"><br>
    <button onclick="fetchData()">Geschützte Daten abrufen</button>
    <p>Status: <strong id="status"></strong></p>
    <pre id="output"></pre>

    <script>
        async function fetchData() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const statusElement = document.getElementById('status');
            const outputElement = document.getElementById('output');

            statusElement.textContent = 'Lädt...';
            outputElement.textContent = '';

            // 1. Credentials im Format "username:password" kombinieren
            const credentials = `${username}:${password}`;

            // 2. Base64-kodieren der Credentials (Vorsicht: Base64 ist keine Verschlüsselung!)
            const encodedCredentials = btoa(credentials);

            // 3. Den "Authorization" Header erstellen
            const headers = {
                'Authorization': `Basic ${encodedCredentials}`,
                'Accept': 'application/json'
            };

            try {
                // Die URL muss der Endpunkt Ihrer C# API entsprechen (z.B. https://localhost:7001/api/daten)
                const response = await fetch('https://localhost:5222/api/daten', {
                    method: 'GET',
                    headers: headers
                });

                if (response.ok) {
                    const data = await response.json();
                    statusElement.textContent = 'Erfolgreich!';
                    statusElement.style.color = 'green';
                    outputElement.textContent = JSON.stringify(data, null, 2);
                } else {
                    statusElement.textContent = `Fehler: ${response.status} ${response.statusText}`;
                    statusElement.style.color = 'red';
                    outputElement.textContent = await response.text();
                }
            } catch (error) {
                statusElement.textContent = 'Netzwerkfehler beim Abrufen der API.';
                statusElement.style.color = 'red';
                console.error(error);
            }
        }
    </script>
    //*/-->

    <h1 onclick="checkLoginStatus();">Login</h1>
    <form id="loginForm">
        <input type="text" id="username" placeholder="Benutzername (testuser)" required value="testuser"><br>
        <input type="password" id="password" placeholder="Passwort (password123)" required value="password123"><br>
        <button type="submit">Login</button>
    </form>
    <!--<p id="loginMessage"></p>-->
    <button onclick="logout()">Logout</button>

    <hr>

    <h1>Geschützte Daten abrufen</h1>
    <button id="fetchData">Daten abrufen</button>
    <pre id="dataOutput"></pre>
    <p id="dataMessage"></p>

    <script>
        // Token-Schlüssel konstant halten
        //const TOKEN_KEY = 'accessToken';
        //const LOGGED_USER = 'userName';
        const API_URL = 'http://' + window.location.host + ':80'; // 'http://localhost:5222'; // Passen Sie den Port Ihrer ASP.NET API an

        // Funktion zum Überprüfen des Login-Status beim Laden der Seite
        //function checkLoginStatus() {
        //    if (sessionStorage.getItem(TOKEN_KEY)) {
        //        document.getElementById('loginMessage').textContent = 'Eingelogged: ' + sessionStorage.getItem(LOGGED_USER);
        //        document.getElementById('loginMessage').style.color = 'green';
        //    } else {
        //        document.getElementById('loginMessage').textContent = 'Kein Benutzer';
        //        document.getElementById('loginMessage').style.color = 'white';
        //    }
        //}
        //window.onload = checkLoginStatus;


        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const messageEl = document.getElementById('loginMessage');
            messageEl.textContent = 'Logge ein...';

            try {
                const response = await fetch(`${API_URL}/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password }),
                });

                if (response.ok) {
                    const data = await response.json();
           
                    // Speichere das Token im sessionStorage
                    sessionStorage.setItem(TOKEN_KEY, data.V);
                    sessionStorage.setItem(LOGGED_USER, username);

                    messageEl.textContent = 'Eingelogged: ' + sessionStorage.getItem(LOGGED_USER);;
                    messageEl.style.color = 'green';
                } else {
                    messageEl.textContent = 'Login fehlgeschlagen. Überprüfe Anmeldedaten.';
                    messageEl.style.color = 'red';
                }
            } catch (error) {
                messageEl.textContent = 'Ein Fehler ist aufgetreten beim Login.' + error;
                messageEl.style.color = 'red';
            }
        });

        // Logout Funktion
        function logout() {
            sessionStorage.removeItem(TOKEN_KEY); // Token entfernen
            sessionStorage.removeItem(LOGGED_USER); // Token entfernen
            checkLoginStatus(); // Status aktualisieren
            document.getElementById('dataOutput').textContent = '';
            document.getElementById('dataMessage').textContent = 'Logout erfolgreich.';
        }


        document.getElementById('fetchData').addEventListener('click', async () => {
            const outputEl = document.getElementById('dataOutput');
            const messageEl = document.getElementById('dataMessage');
            outputEl.textContent = 'Lade Daten...';
            messageEl.textContent = '';

            // Token aus sessionStorage abrufen
            const accessToken = sessionStorage.getItem(TOKEN_KEY);

            if (!accessToken) {
                messageEl.textContent = 'Kein Token verfügbar. Bitte zuerst einloggen.';
                return;
            }

            try {
                const response = await fetch(`${API_URL}/protecteddata`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`, // Token im Header senden
                    },
                });

                if (response.ok) {
                    const data = await response.text();
                    outputEl.textContent = data;
                } else if (response.status === 401 || response.status === 403) {
                    messageEl.textContent = 'Nicht autorisiert. Token abgelaufen oder ungültig.';
                    messageEl.style.color = 'red';                   
                    sessionStorage.removeItem(TOKEN_KEY);
                } else {
                    messageEl.textContent = 'Fehler beim Abrufen der Daten.';
                    messageEl.style.color = 'red';
                }
            } catch (error) {
                messageEl.textContent = 'Netzwerkfehler beim Datenabruf.' + error;
                messageEl.style.color = 'red';
            }
        });
    </script>

</body>
</html>