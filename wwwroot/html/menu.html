<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Kreutzträger WebApp</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel='icon' type='image/x-icon' href='/favicon.ico'>
    <link rel='stylesheet' href='/css/style.css'>
    <script src='/js/websocket.js'></script>
</head>
<body>
    <h1>Kreutzträger WebApp</h1>

    <ul>
        <li><a class="menuitem" href="/all">Demo Übersicht der aufgezeichneten Datenpunkte</a></li>
        <li><a class="menuitem" href="/html/soll/test.html">Demo Sollwertfenster</a></li>
        <li><a class="menuitem" href="/chart">Demo Kurvendarstellung</a></li>
        <li><a class="menuitem" id="rawjsonlink" href="#">Demo Json Rohdaten abfragen</a></li>
        <li><a class="menuitem" href="/excel">Demo Datenexport via Excel</a></li>
    </ul>

    <script>
        const start = new Date();
        start.setHours(0, 0, 0);
        start.toISOString().replace(" ", "%3A")

        const end = new Date();
        end.toISOString().replace(" ", "%3A");

        document.getElementById('rawjsonlink').setAttribute('href', `/db?tagnames=A01_DB10_DBW2%2CA01_DB10_DBW4%2CA01_DB10_DBW6&start=${start}&end=${end}`)
    </script>

    <div id="logincard">        
        <form id="loginForm">
            <div id="loginheader" onclick="checkLoginStatus();">Login</div>
            <input type="text" id="username" placeholder="Benutzername (testuser)" required value="testuser"><br>
            <input type="password" id="password" placeholder="Passwort (password123)" required value="password123"><br>
            <button onclick="login()">Login</button><button onclick="logout()">Logout</button>
        </form>           
    </div>
   
    <script>

        async function login() {
           
            const el = document.getElementById('loginMessage');
            el.textContent = 'Logge ein...';

            try
            {
                const usr = document.getElementById('username').value;
                const pwd = document.getElementById('password').value;      
                const url = 'http://' + window.location.host + '/login';
             
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include', // Erlaubt das Setzen/Senden von Cookies
                    body: JSON.stringify(new JsonTag(usr, pwd))                        
                })
                    //.then(response => response.json())
                    //.then(data => { console.log(data); })
                    ;

                if (res.ok) alert('Cookie wurde vom Server gesetzt!');

                if (res.ok) {                 
                    sessionStorage.setItem(LOGGED_USER, usr);
                    el.textContent = usr; //await res.json().message + usr;
                    el.style.color = 'green';
                } else {
                    el.textContent = 'Login fehlgeschlagen. Überprüfe Anmeldedaten.';
                    el.style.color = 'red';
                }
            } catch (error) {
                el.textContent = 'Ein Fehler ist aufgetreten beim Login.' + error;                
                el.style.color = 'red';
                console.warn(el.textContent);
            }
        }

        // Logout Funktion
        async function logout() {

            const el = document.getElementById('loginMessage');
            el.textContent = 'Logge aus...';

            const res = await fetch('/logout', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: ""
            });

            if (res.ok) {
                sessionStorage.removeItem(LOGGED_USER);
                el.textContent = await res.json().message + usr;
                el.style.color = 'white';
            } else {
                el.textContent = 'Login fehlgeschlagen. Überprüfe Anmeldedaten.';
                el.style.color = 'red';
            }

        }

    </script>
    <style>
        #logincard{
            position:absolute;
            right:11rem;
            top: 3rem; 
            width: 10rem;
        }

        @media (max-width: 1000px) {
            #logincard {
                right: 1rem;
                margin-right:1rem;
            }
        }

        #logincard button {           
            width:5rem;
            background-color:white;
            font-size:1.1rem;
        }

        #loginheader {
            padding: 0.2rem;
            width: 10rem;
            color: white;
            font-size: 1.3rem;
        }
    </style>
</body>
</html>