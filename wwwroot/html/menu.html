<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Kreutzträger WebApp</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel='icon' type='image/x-icon' href='/favicon.ico'>
    <link rel='stylesheet' href='/css/style.css'>
    <script src='/js/websocket.js'></script>   
</head>
<body>
    <h1>Kreutzträger WebApp</h1>

    <div id="logincard">
        <div id="loginheader" onclick="checkLoginStatus();">Login</div>   
        <input type="text" id="username" placeholder="Benutzername" value="Admin"><br />
        <input type="password" id="password" placeholder="Passwort" value="Admin" onchange="login()"><br />
        <button onclick="login()">Login</button><button onclick="logout()">Logout</button>
    </div>

    <h3>Systemmenü</h3>      
    <ul>
        <li><a class="menuitem" href="/tag/all">Datenpunkte</a></li>
        <li><a class="menuitem" href="/user">Benutzerverwaltung</a></li>
        <li><a class="menuitem" href="/log">Server Log</a></li>
        <li><a class="menuitem" href="/excel">Datenexport</a></li>
    </ul>

    <h3>Demo</h3>
    <ul>
        <li><a class="menuitem" href="/source">Datenquellen</a></li>
        <li><a class="menuitem" href="/tag/failures">Letzte Lesefehler</a></li>
        <li><a class="menuitem" href="/soll/1">Demo Sollwertfenster</a></li>
        <li><a class="menuitem" href="/chart">Demo Kurvendarstellung</a></li>
        <li><a class="menuitem" id="rawjsonlink" href="#">Demo Json Rohdaten abfragen</a></li>       
    </ul>

    <script>
        const start = new Date();
        start.setHours(0, 0, 0);
        start.toISOString().replace(" ", "%3A")

        const end = new Date();
        end.toISOString().replace(" ", "%3A");

        document.getElementById('rawjsonlink').setAttribute('href', `/db?tagnames=A01_DB10_DBW2%2CA01_DB10_DBW4%2CA01_DB10_DBW6&start=${start}&end=${end}`)

        const API_URL = 'https://' + window.location.host;

        async function login() {
            const body = document.getElementsByTagName('BODY')[0];            
            const el = document.getElementById('loginMessage');
            el.textContent = 'Logge ein...';

            const username = document.getElementById("username").value;
            const password = document.getElementById("password").value;

            try {
                body.style.cursor = 'wait';
                const response = await fetchSecure(`${API_URL}/login`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ username, password })
                });

                if (response.ok) {
                    const data = await response.json();
                    const csrfToken = data.requestToken;
                    sessionStorage.setItem(TOKEN_NAME, csrfToken);
                    sessionStorage.setItem(LOGGED_USER, username);
                    el.textContent = username;
                    el.style.color = 'green';
                } else {
                    el.textContent = 'Login fehlgeschlagen. Überprüfe Anmeldedaten.';
                    el.style.color = 'red';
                }
            } catch (e) { console.error("Fehler beim Login: " + e); }
            finally {
                body.style.cursor = 'auto';
            }
        }

        async function logout() {
            const body = document.getElementsByTagName('BODY')[0]; 
            const el = document.getElementById('loginMessage');
            el.textContent = 'Logge aus...';
            body.style.cursor = 'wait';

            const response = await fetchSecure(`${API_URL}/logout`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ username })
            });

            sessionStorage.removeItem(TOKEN_NAME);
            if (response.ok) {
                const loggedUser = sessionStorage.getItem(LOGGED_USER);
                if (loggedUser) {
                    sessionStorage.removeItem(LOGGED_USER);
                    el.textContent = loggedUser + ' ausgeloggt';
                    el.style.color = 'red';
                }
            }
            else {
                el.textContent = 'Kein Benutzer ?';
                el.style.color = 'orange';
            }
            body.style.cursor = 'auto';
        }
    </script>



    <style>
        #logincard {
            position: absolute;
            right: 11rem;
            top: 3rem;
            width: 15rem;
        }

        @media (max-width: 1000px) {
            #logincard {
                position: relative;
                left: 2.5rem;
                top: 0;
            }
        }

        #logincard button {
            width: 50%;
            background-color: white;
            font-size: 1.1rem;
        }

        #logincard input {
            width: 100%
        }

        #loginheader {
            padding: 0.5rem 0.1rem;
            color: white;
            font-size: 1.3rem;
        }

    </style>
</body>
</html>